# Phase 15C: TRAVI System Invariants & Guarantees

**Date:** 2026-01-01
**Phase:** Core Intelligence Wiring & Architecture Corrections
**Purpose:** Document the architectural contracts that the TRAVI platform guarantees

---

## Content Lifecycle Invariants

### INVARIANT 1: Content Publish → Event Emission ✅

When content status transitions to "published", the `content.published` event MUST be emitted.

**Triggers:**
- Search indexing
- AEO capsule generation
- Internal links cache invalidation

**Enforced in:**
- `server/content/content-lifecycle.ts` (transitionState) - **FIXED in Phase 15C**
- `server/routes.ts` (PATCH /api/contents/:id)
- `server/auto-pilot.ts` (processScheduledContent)

---

### INVARIANT 2: Published Content → Search Indexed ✅

All published content MUST be indexed in the search system within the same request/event cycle.

**Enforced in:**
- `server/events/content-subscribers.ts` (handleSearchIndexOnPublish)

---

### INVARIANT 3: Published Content → AEO Eligible ✅

All published content MUST have an AEO capsule generated (or attempted).

**Enforced in:**
- `server/events/content-subscribers.ts` (handleAEOGenerationOnPublish)

---

## Entity Lifecycle Invariants

### INVARIANT 4: Octopus Extraction → Entity Persistence ✅

When Octopus extracts entities from a document, those entities MUST be persisted to the database via `batchUpsertEntities()`.

**Ensures:**
- Chat can reference real entities
- Search can surface extracted entities
- Internal linking can use extracted entities

**Enforced in:**
- `server/octopus/orchestrator.ts` (runAgentPipeline, after Agent 1) - **FIXED in Phase 15C**

---

### INVARIANT 5: Entity Links → Validated ✅

All entity links returned by Chat MUST be validated against the database. The system MUST NOT return links to non-existent entities.

**Enforced in:**
- `server/navigation/entity-resolver.ts` (resolveEntityLink)
- `server/chat/chat-handler.ts` (uses entity-resolver)

---

## Intelligence Flow Invariants

### INVARIANT 6: Internal Links → Database-Driven ✅

Internal linking engine MUST prefer database content over hardcoded data. When content is published/updated, the internal links cache MUST be cleared.

**Enforced in:**
- `server/ai/internal-linking-engine.ts` (getAllLinkTargets, loadLinkableContentFromDB) - **FIXED in Phase 15C**
- `server/events/content-subscribers.ts` (handleInternalLinksCacheOnPublish) - **ADDED in Phase 15C**

---

### INVARIANT 7: Search → Intent-Aware ✅

Search results MUST be influenced by detected user intent. The unified cognitive layer MUST merge signals from search and chat.

**Enforced in:**
- `server/cognitive/unified-layer.ts`
- `server/search/search-service.ts`

---

## Data Integrity Invariants

### INVARIANT 8: No Orphaned Intelligence ⚠️ PARTIAL

Intelligence generated by any pipeline MUST be persisted or explicitly discarded.

**Status:**
| Pipeline | Persisted | Notes |
|----------|-----------|-------|
| Entity extraction | ✅ YES | Fixed in Phase 15C |
| Octopus job records | ✅ YES | job-persistence.ts |
| AEO capsules | ✅ YES | aeoAnswerCapsules table |
| Octopus articles | ❌ NO | Requires manual export |

**Remaining Gap:** Octopus-generated articles not auto-published to contents table

---

### INVARIANT 9: Single Source of Truth ✅

Each entity type MUST have a single authoritative source:

| Entity Type | Authoritative Source |
|-------------|---------------------|
| Destinations | `destinations` table |
| Hotels | `hotels` + `contents` tables |
| Attractions | `attractions` + `contents` tables |
| Articles | `contents` table |
| Extracted Entities | `entity-upsert` → appropriate tables |

Hardcoded data is fallback only, not authoritative.

---

## System Health Invariants

### INVARIANT 10: Graceful Degradation ✅

If a downstream subscriber fails (search indexing, AEO generation), the content publish MUST still succeed. Failures are logged but not propagated.

**Enforced in:**
- `server/events/content-subscribers.ts` (try/catch in all handlers)

---

### INVARIANT 11: Audit Trail ✅

All content status changes MUST be logged to the `audit_logs` table.

**Enforced in:**
- `server/content/content-lifecycle.ts` (transitionState)

---

## Known Gaps (Future Phases)

### GAP 1: RSS → Entity Extraction ⚠️

RSS article generation does NOT call entity extraction.

**Location:** `server/routes.ts` - `autoProcessRssFeeds()`
**Impact:** RSS articles cannot be linked to destinations/attractions
**Priority:** MEDIUM

---

### GAP 2: Octopus → Auto-Publish ⚠️

Octopus generates content but does not auto-publish to contents table.

**Location:** `server/octopus/orchestrator.ts`
**Impact:** Manual step required to use Octopus output
**Priority:** HIGH

---

### GAP 3: Search → Dynamic Entity Recognition ⚠️

Search intent classifier uses hardcoded `DUBAI_LOCATIONS` array instead of querying entities from database.

**Location:** `server/search/intent-classifier.ts`
**Impact:** New destinations not recognized in search queries
**Priority:** MEDIUM

---

## Implementation Summary (Phase 15C)

### Files Modified

1. **`server/content/content-lifecycle.ts`**
   - Added import for event emitters
   - Added event emission after successful publish transition
   - Fetches full content data for event payload

2. **`server/octopus/orchestrator.ts`**
   - Added import for `batchUpsertEntities`
   - Added entity persistence call after Agent 1 (Entity Extraction)
   - Non-blocking - pipeline continues even if persistence fails

3. **`server/ai/internal-linking-engine.ts`**
   - Added database imports and cache variables
   - Added `loadLinkableContentFromDB()` - fetches destinations, content, categories
   - Added `getAllLinkTargets()` - combines DB + hardcoded fallback
   - Added `clearLinksCacheFromDB()` - cache invalidation
   - Added async versions: `insertInternalLinksAsync()`, `suggestInternalLinksAsync()`

4. **`server/events/content-subscribers.ts`**
   - Added import for `clearLinksCacheFromDB`
   - Added `handleInternalLinksCacheOnPublish()` subscriber
   - Added `handleInternalLinksCacheOnUpdate()` subscriber
   - Registered both subscribers in `initializeContentSubscribers()`

---

## Verification Commands

```bash
# Check if event emission is wired
grep -n "emitContentPublished" server/content/content-lifecycle.ts

# Check if entity upsert is called in Octopus
grep -n "batchUpsertEntities" server/octopus/orchestrator.ts

# Check if internal links engine has DB functions
grep -n "loadLinkableContentFromDB\|getAllLinkTargets" server/ai/internal-linking-engine.ts

# Check if cache clearing is subscribed
grep -n "InternalLinksCache" server/events/content-subscribers.ts
```
